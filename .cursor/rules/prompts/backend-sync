# âœ… Backend-Sync Plan fÃ¼r XP, Fortschritt & Belohnungen (Supabase)

## ğŸ¯ Ziel

Die bisher lokal im Frontend berechneten Spiel- und Fortschrittsdaten (XP, Coins, Medaillen, Jokerverbrauch, Quizfortschritt) sollen serverseitig Ã¼ber Supabase verarbeitet, gespeichert und validiert werden. Das schÃ¼tzt gegen Manipulation, sichert die Daten langfristig und ermÃ¶glicht ein skalierbares Level- und Rankingsystem.

---

## ğŸ§© 1. XP-Vergabe (ersetzt: addXP aus Frontend)

### âœ… Umsetzung:
- Supabase-Funktion: `calculate_and_award_xp(p_user_id UUID, p_correct_answers INTEGER, p_question_ids UUID[])`
- Vergibt XP nur fÃ¼r **neue, korrekt beantwortete Fragen**
- Fragetypen werden berÃ¼cksichtigt:
  - `"case-main"` = 0 XP
  - `"case-subquestion"` & `"normal"` = 10 XP

### âœ… Aufgaben:
- Frontend ruft nicht `addXP()`, sondern `supabase.rpc("calculate_and_award_xp", {...})`
- XP werden zentral in `profiles` oder `user_stats` gespeichert
- Optional: XP-Log-Tabelle fÃ¼r Historie

---

## ğŸ¥‡ 2. Medaillen-Vergabe

### âœ… Umsetzung:
- Tabelle: `unlocked_medals (user_id, medal_id, unlocked_at)`
- Frontend ruft `unlockMedal()` **nur** bei tatsÃ¤chlichem Event
- Backend prÃ¼ft: existiert bereits? â†’ wenn ja, keine erneute Vergabe

### âœ… Aufgaben:
- Mutation `unlockMedal` aufrufen (idealerweise mit Medaillen-Regellogik im Backend)
- Supabase-Check: existiert `(user_id, medal_id)`?

---

## ğŸ§¾ 3. Fortschritt speichern

### âœ… Umsetzung:
- Tabelle: `chapter_progress (user_id, chapter_id, correct_count, total_count)`
- Fortschritt wird nach jeder Antwort per Mutation aktualisiert

### âœ… Aufgaben:
- Mutation `trackProgress(chapterId, correctCount)` o.â€¯Ã¤.
- optional: Backend berechnet Fortschritt Ã¼ber `answered_questions`

---

## ğŸƒ 4. Jokerverbrauch speichern

### âœ… Umsetzung:
- Tabelle: `joker_usage (user_id, joker_type, quiz_id, used_at)`
- Beim Einsatz eines Jokers: Mutation `useJoker(type)`

### âœ… Aufgaben:
- Frontend-Trigger bei Joker-Verbrauch
- Supabase speichert Eintrag â€“ ggf. `unique(user_id, quiz_id, joker_type)`

---

## ğŸ§  5. Antwort-Logik zentralisieren

### âœ… Umsetzung:
- Mutation: `submitAnswer(question_id, is_correct)`
- Backend prÃ¼ft:
  - ob bereits beantwortet (â†’ keine XP-Vergabe)
  - Fragetyp (â†’ wie viel XP)
  - speichert in `answered_questions`

### âœ… Aufgaben:
- Bestehende lokale `submitAnswer` durch sichere Supabase-Mutation ersetzen
- XP + Fortschritt + Antwortspeicherung in einer zentralen RPC oder Mutation bÃ¼ndeln

---

## ğŸ“Š 6. Quiz-Sessions (optional)

### âœ… Umsetzung:
- Tabelle: `quiz_sessions (user_id, chapter_id, xp_earned, correct, time_spent, used_jokers)`
- Wird am Quiz-Ende gespeichert

### âœ… Aufgaben:
- `completeQuizSession()` am Endscreen aufrufen
- Daten aus Zustand aggregieren, dann zentral speichern

---

## ğŸ” Sicherheit & Fairness

- Row Level Security (RLS) aktivieren fÃ¼r alle Tabellen
- Nur authentifizierte Nutzer dÃ¼rfen auf eigene Zeilen schreiben
- Optional: XP-Vergabe nur Ã¼ber `rpc()` zulassen, keine direkte Bearbeitung von `user_stats`

---

## âœ… Zusammenfassung: Was ersetzt wird

| Bisher im Frontend               | ZukÃ¼nftig im Backend (Supabase)       |
|----------------------------------|----------------------------------------|
| `addXP(10)`                      | `calculate_and_award_xp(...)` RPC     |
| XP in Zustand erhÃ¶hen            | XP in `profiles`/`user_stats` speichern |
| Medaillen lokal vergeben         | `unlocked_medals` + Check             |
| Joker lokal speichern            | `joker_usage`                         |
| Fortschritt in Zustand zÃ¤hlen    | `chapter_progress`                    |
| Antworten nur lokal gespeichert  | `answered_questions` mit Doppel-PrÃ¼fung |

---

## ğŸ“¦ Frontend-Nutzung

- Alle Mutationen Ã¼ber `useMutation()` mit Supabase `rpc()` oder `insert()`-Logik
- `queryKeys.ts` fÃ¼r neue Query: `userStats`, `unlockedMedals`, `chapterProgress`
- `useQuizData.ts` â†’ zentralisieren

---

## ğŸ“Œ Optional spÃ¤ter

- XP-Historie-Tabelle (`xp_events`)
- Fortschritts-Vergleich: Quiz vs. Kapitel vs. Gesamt
- Joker-Limits pro Tag
- Ranking-Snapshots (Tages/Wochen-Top-10)
